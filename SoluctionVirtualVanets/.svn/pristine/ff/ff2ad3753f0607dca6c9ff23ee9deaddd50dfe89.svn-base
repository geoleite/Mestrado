/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package br.com.virtualVanets.applicationModel.listener;

import br.com.virtualVanets.ServerFactory;
import br.com.virtualVanets.common.Device;
import br.com.virtualVanets.common.OperationRequestDevice;
import br.com.virtualVanets.common.listener.SVVEventDevice;
import br.com.virtualVanets.infracloud.OperationRequestInfraEquipament;
import br.com.virtualVanets.routingAlgorithm.Host;
import br.com.virtualVanets.routingAlgorithm.Network;
import br.com.virtualVanets.routingAlgorithm.RouteTable;
import br.com.virtualVanets.routingAlgorithm.bo.NetworkBO;
import br.com.virtualVanets.serverManager.Server;
import br.com.virtualVanets.vehiclecloud.OperationRequestVehicle;
import br.com.virtualVanets.vehiclecloud.Vehicle;
import br.com.virtualVanets.vehiclecloud.listener.SVVEventVehicle;
import br.com.virtualVanets.vehiclecloud.listener.SVVListenerVehicle;
import com.google.gson.Gson;
import com.google.gson.GsonBuilder;
import java.util.Date;
import java.util.logging.Level;
import java.util.logging.Logger;

/**
 *
 * @author georgejunior
 */
public class DefaultListenerVehicle extends SVVListenerVehicle {

    @Override
    public void onLoopback(SVVEventDevice svvEvent) {
        {
            System.out.println("OnLoopback " + svvEvent.getDate());
            try {
                Host host = new Host();
                host.setDevice(svvEvent.getDevice());
                host = RouteTable.getIntance().getHostTableNetwork(host.getAddress());
                if (host != null) {
                    Network network = host.getNetwork();
                    OperationRequestVehicle orv = new OperationRequestVehicle();
                    orv.setType(Device.OBU);
                    orv.setAltitude(svvEvent.getAltitude());
                    orv.setLatitude(svvEvent.getLatitude());
                    orv.setLongitude(svvEvent.getLongitude());
                    orv.setSpeed(((SVVEventVehicle) svvEvent).getSpeed());
                    orv.setOperationCode(OperationRequestVehicle.LOOP_BACK);
                    orv.setDate(svvEvent.getDate());
                    orv.setMessage(svvEvent.getMessage());
                    Gson gson = new GsonBuilder().setDateFormat(OperationRequestDevice.PARTTERN_DATE).create();
                    String str = gson.toJson(orv);
                    System.out.println("Command loopback " + str);
                    network.sendMsg(host, host, str);
                }
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }

    @Override
    public void onMoviment(SVVEventDevice svvEvent) {
        System.out.println("OnMoviment");
        try {
            Server currentServer = ServerFactory.getInstance().getServerDefault();
            Server server = ServerFactory.getInstance().serverCheck(svvEvent);
            if (server == null) {
                //O Dispositivo não pertence a este servidor
                Server serverSuper = ServerFactory.getInstance().getByServerId(currentServer.getSrv_nr_idsuper());
                onAreaOut(svvEvent);
                sendCommandChangeServer(serverSuper, svvEvent);
            } else if (server.getServerId() != currentServer.getServerId()) {
                onAreaOut(svvEvent);
                sendCommandChangeServer(server, svvEvent);
            }
        } catch (Exception ex) {
            Logger.getLogger(DefaultListenerVehicle.class.getName()).log(Level.SEVERE, null, ex);
        }
    }

    /**
     * Envia comando de changeServer para o dispositivo
     *
     * @param server Servidor de destino
     * @param svvEvent Dispositivo que deve trocar de servidor
     * @throws Exception
     */
    private void sendCommandChangeServer(Server server, SVVEventDevice svvEvent) throws Exception {
        //Obtendo o endereço do Servidor Pai
        OperationRequestVehicle orv = new OperationRequestVehicle();
        orv.setOperationCode(OperationRequestVehicle.CHANGE_SERVER);
        orv.setDate(new Date());
        orv.setType(Device.OBU);
        orv.setMessage(server.getServerAddress());
        Gson gson = new GsonBuilder().setDateFormat(OperationRequestDevice.PARTTERN_DATE).create();
        String str = gson.toJson(orv);
        //Enviando comando para o dispositivo
        Host host = new Host();
        host.setDevice(svvEvent.getDevice());
        NetworkBO.getInstance().getByArea(0, 0).sendMsg(host, host, str);
    }

    @Override
    public void onAreaIn(SVVEventDevice event) {
        System.out.println("OnAreaIn");
    }

    @Override
    public void onAreaOut(SVVEventDevice svvEvent) {
        System.out.println("OnAreaOut");
        Host host = new Host();
        host.setDevice(svvEvent.getDevice());
        host = RouteTable.getIntance().getHostTableNetwork(host.getAddress());
        host.getNetwork().removeHost(host);
    }

    @Override
    public void onRead(SVVEventDevice event) {
        System.out.println("OnRead");
    }
    
    @Override
    public void onConnect(SVVEventDevice event) {
        try {

            System.out.println("OnConnect " + event.getDevice().getClass().getName());
            /*
            //Verifica se a localização pertence à área deste servidor
            Server currentServer = ServerFactory.getInstance().getServerDefault();
            Server server = ServerFactory.getInstance().serverCheck(event);
            if (server == null) {
                //Id Super com valor zero, indica que esse servidor é o raiz da árvore de servidores
                if (currentServer.getSrv_nr_idsuper() != 0) {
                    Server serverSuper = ServerFactory.getInstance().getByServerId(currentServer.getSrv_nr_idsuper());
                    sendCommandChangeServer(serverSuper, event);
                }
            } else if (server.getServerId() != currentServer.getServerId()) {
                // O dispositivo deve ser realocado pra algum filho deste servidor
                sendCommandChangeServer(server, event);
            } else {
             */
            //Criando o host
            Host host = new Host();
            host.setDevice(event.getDevice());
            //Por enquanto todos estão usando uma única rede de maneira forçada
            //Depois deve mudar pra pegar do banco.
            Network network = NetworkBO.getInstance().getByArea(event.getLatitude(), event.getLongitude());
            //Adiciona o host na red
            network.addHost(host);
            //RouteTable.getIntance().addTableNetworkOBU((Vehicle)event.getDevice());
//                onAreaIn(event);
//            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    @Override
    public void onDisconnet(SVVEventDevice event) {
        System.out.println("OnDisconnect");
    }

    private void onMessageBoreadCast(SVVEventDevice svvEvent) {
        System.out.println("OnMessageBoreadCast");
        try {
            Host host = new Host();
            host.setDevice(svvEvent.getDevice());
            host = RouteTable.getIntance().getHostTableNetwork(host.getAddress());
            if (host != null) {
                Network network = host.getNetwork();
                network.sendMsg(host, null, svvEvent.getMessage());
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    @Override
    public void callEvent(SVVEventDevice svvEvent) {
        switch (svvEvent.getOperationCode()) {
            case OperationRequestVehicle.LOOP_BACK:
                onLoopback(svvEvent);
                break;
            case OperationRequestVehicle.MOVIMENTATION_CODE:
                onMoviment(svvEvent);
                break;
            case OperationRequestVehicle.SEND_CODE:
                onRead(svvEvent);
                break;
            case OperationRequestVehicle.SEND_BROADCAST_CODE:
                onMessageBoreadCast(svvEvent);
                break;
            case OperationRequestVehicle.DISCONNECT_CODE:
                onDisconnet(svvEvent);
                break;
            case OperationRequestVehicle.CONNECT_CODE:
                onConnect(svvEvent);
                break;
        }
    }
}
